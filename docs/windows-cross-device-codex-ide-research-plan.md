# 单机版 Windows 远程开发工作台（手机/电脑跨端）最终需求确认与实施计划

> 版本定位：**仅 1 台已部署 Tailscale 的 Windows 10 Pro 主机**，仅支持 **Codex / Claude Code**，仅采用**全局密码门禁**。本文档为当前版本最终范围与执行依据。

---

## 1. 最终范围定义（冻结）

### 1.1 项目目标
构建一个可在手机端与电脑端访问的开发工作台，连接到同一台 Win10 主机，实现：
1. 类 VS Code 的基础编辑体验（文件树、文本编辑、搜索、Git diff、终端）。
2. Codex 与 Claude Code 两类 AI 终端工作流。
3. 断线后会话保持、后台运行、重新接入后无缝衔接。
4. 所有操作状态回到 Win10 主机后可见（真实文件、真实 Git 状态、真实终端结果）。

### 1.2 强约束（必须满足）
1. **仅一台主机**：不支持多主机、不做主机切换。
2. **仅 Tailscale 网络**：客户端与 Win10 均在同一 Tailnet。
3. **仅全局密码**：进入系统只需要一个全局密码；未通过前看不到任何内容。
4. **仅 Codex / Claude Code**：不接入第三类模型。
5. **仅基础 IDE 能力**：满足开发刚需，不做重型 IDE 特性。

### 1.3 明确不做（当前版本）
1. 企业 SSO / OAuth / MFA。
2. RBAC、组织管理、审批流。
3. 多人实时协作编辑。
4. 多主机池、自动扩缩容。
5. 全量 VS Code Marketplace 插件兼容。
6. 复杂图形调试器、远程容器编排。

---

## 2. 使用场景与用户流（单用户）

### 2.1 核心用户流 A（手机救火）
1. 手机打开系统 -> 输入全局密码。
2. 自动恢复上次工作区与终端。
3. 查看错误日志与 Git diff。
4. 调用 Codex 或 Claude Code 生成修复。
5. 审核 patch -> 应用 -> 终端验证。
6. 提交代码，退出；任务在后台继续。

### 2.2 核心用户流 B（电脑深度开发）
1. 电脑端登录（同一密码门禁）。
2. 无缝接管手机端会话（打开文件、光标、终端历史同步）。
3. 继续开发与调试。
4. 回到 Win10 主机本地 IDE / 终端可看到同样状态与变更结果。

### 2.3 核心用户流 C（跨端接力）
1. 电脑发起长任务（测试/构建）。
2. 合盖或断网后任务继续在 Win10 后台执行。
3. 手机再次登录查看实时输出与最终结果。

---

## 3. 安全与鉴权（最简且可用）

### 3.1 全局密码门禁规范
1. 登录页仅提供“密码输入 + 登录按钮”。
2. 密码正确才创建会话令牌（建议 Access Token + Refresh Token）。
3. 密码错误返回统一失败提示，不泄露系统信息。
4. 未认证用户访问任意 API 均返回 401，不返回目录树/主机信息。

### 3.2 密码存储与防护
1. 密码只存哈希（Argon2id 或 bcrypt），禁止明文。
2. 增加失败速率限制：
   - 连续 5 次失败，锁定 5 分钟；
   - 连续 10 次失败，锁定 30 分钟并记录告警。
3. 会话超时策略：
   - 空闲超时：24 小时；
   - 最大会话时长：7 天。

### 3.3 最小审计要求
记录以下事件（本地即可）：
1. 登录成功/失败（时间、客户端类型）。
2. 命令执行记录（命令、目录、退出码、时长）。
3. AI 发起的写文件/执行命令行为。

---

## 4. 网络与部署（固定 Tailscale）

### 4.1 前置条件
1. Win10 Pro 已安装并登录 Tailscale。
2. 客户端设备（手机/电脑）同样加入该 Tailnet。
3. Win10 防火墙放行应用端口（如 8080/8443）。

### 4.2 连接模式
1. 客户端通过 Tailscale IP 或 MagicDNS 访问服务。
2. 服务监听 `0.0.0.0:<port>`（仅 Tailnet 可达）。
3. 不实现 NAT 打洞 / TURN / Relay。

### 4.3 故障排查最小清单
1. `tailscale status` 查看双方在线状态。
2. `tailscale ping <win10-node>` 验证连通。
3. 检查 Win10 服务进程是否存活、端口是否监听。
4. 检查防火墙与杀软策略是否拦截。

---

## 5. 功能清单（最终确认）

## 5.1 MVP Must（必须实现）

### 5.1.1 文件与目录
1. 目录树展示（懒加载）。
2. 新建/重命名/删除：文件、文件夹。
3. 拖拽移动（可选但建议）。
4. 最近打开文件列表。

### 5.1.2 文本编辑器（VSCode 基础）
1. 多标签页编辑。
2. 基本语法高亮。
3. 查找/替换（文件内 + 全局文本搜索）。
4. 自动保存（可配置：关闭/延时/失焦）。
5. 行号、缩进、括号匹配。

### 5.1.3 Git 基础能力
1. 工作区改动列表（modified/untracked/staged）。
2. 文件级与行级 diff 查看。
3. 分块暂存（stage hunk）与撤销改动（discard hunk/file）。
4. 冲突文件识别与基础冲突视图。

### 5.1.4 终端
1. 新建终端（支持 PowerShell 优先）。
2. 多终端标签切换。
3. 复制/粘贴、清屏、搜索历史输出。
4. 终端断线重连后可继续查看缓冲输出。

### 5.1.5 AI（仅 Codex / Claude Code）
1. Provider 二选一启动，支持快速切换。
2. 统一工具接口：`read`, `write`, `search`, `exec`, `git`。
3. AI patch 必须可预览，用户确认后才应用。
4. AI 执行命令前可配置“总是确认 / 白名单自动执行”。

### 5.1.6 跨端会话保持
1. 保存打开文件列表、光标位置、滚动位置。
2. 保存终端会话元数据与缓冲。
3. 保存 AI 对话历史与上下文引用。
4. 手机与电脑登录后可恢复同一会话继续操作。

### 5.1.7 后台运行与无缝衔接
1. 客户端断开后，Win10 上任务继续执行。
2. 重新登录后可看到进行中的任务输出。
3. Win10 本机查看时，文件与 Git 状态与远程一致。

## 5.2 Should（建议实现）
1. 主题切换（浅色/深色 + 2~3 套常用主题）。
2. SQLite 数据库查看（只读优先，后续再加编辑）。
3. 移动端快捷键栏（Tab/Esc/Ctrl/方向键）。
4. 命令模板（如 `git status`, `npm test` 一键执行）。

## 5.3 Won’t（本期不做）
1. 插件市场安装器与插件沙箱。
2. 完整 LSP 深度重构能力（保留基础语法能力即可）。
3. 多人实时协同。
4. 云端中继和公网暴露。

---

## 6. Cursor 插件“部分支持”边界定义

### 6.1 兼容目标
1. **主题类能力**：支持主题切换配置。
2. **SQLite 浏览能力**：支持打开 `.db/.sqlite` 文件并查看表结构和数据。

### 6.2 兼容方式
1. 采用“功能等价”而非“插件二进制兼容”。
2. 对用户暴露相似入口（侧栏/命令面板），但内部实现可自研。

### 6.3 验收标准
1. 用户可在 UI 中切换主题并持久化。
2. 用户可连接本地 SQLite 文件，查看表列表与分页数据。

---

## 7. 数据与状态一致性规范（重点）

### 7.1 状态存储对象
1. UI 状态：打开标签、面板布局、主题。
2. 编辑状态：光标、选区、未保存草稿（可选自动临时快照）。
3. 终端状态：终端 ID、工作目录、输出缓冲。
4. AI 状态：会话线程、工具调用记录、patch 审核记录。

### 7.2 一致性原则
1. 文件写入始终直写 Win10 实际文件系统（非镜像副本）。
2. Git 操作始终作用于 Win10 实际仓库。
3. 终端命令始终在 Win10 实际 shell 执行。

### 7.3 冲突处理
1. 检测到文件被外部修改（如本机 VSCode 改动）时，提示“重新加载/对比合并”。
2. 未保存草稿冲突时，提供三方选择：覆盖、放弃、手动合并。

---

## 8. 技术方案（单机最小实现）

### 8.1 推荐栈
1. 前端：TypeScript + React + Monaco。
2. 后端/BFF：TypeScript (Node.js/Nest 或 Fastify)。
3. Win10 Agent：Rust（ConPTY、文件监控、命令执行）。
4. 存储：SQLite（配置/会话）+ 本地文件日志。

### 8.2 模块划分
1. `auth-gate`：全局密码、会话签发。
2. `workspace-api`：文件树、编辑、搜索、Git API。
3. `terminal-service`：终端创建、输入输出流、缓冲持久化。
4. `ai-orchestrator`：Codex/Claude 适配与工具调用。
5. `session-store`：跨端恢复与后台任务索引。

### 8.3 通信协议
1. HTTP：文件/Git/配置等普通请求。
2. WebSocket：终端实时流、任务状态推送。

---

## 9. 分阶段执行计划（精简版）

## Phase A（1~2 周）：基础可连接
1. 接通 Tailscale 访问链路。
2. 完成全局密码门禁。
3. 打通文件树浏览 + 文本打开保存。

**阶段验收**
- 在手机与电脑可通过同一地址登录并访问同一工作区。

## Phase B（2~4 周）：开发基础可用
1. 完成编辑器基础能力与全局搜索。
2. 完成 Git 改动列表与 diff/hunk 处理。
3. 完成多终端与断线重连。

**阶段验收**
- 能独立完成一次“修改代码 -> 看 diff -> 运行命令 -> 提交”的闭环。

## Phase C（2~3 周）：AI 与会话无缝
1. 接入 Codex 与 Claude Code。
2. 完成 read/write/search/exec/git 工具接口。
3. 完成跨端会话恢复与后台任务持续。

**阶段验收**
- 手机发起任务，电脑接力继续；回到 Win10 本机可见完整状态。

## Phase D（1~2 周）：体验补齐
1. 主题切换。
2. SQLite 浏览器（只读）。
3. 移动端快捷键栏与交互细节优化。

**阶段验收**
- 完成“主题切换 + DB 查看 + 手机终端操作”三项体验验证。

---

## 10. 最终验收清单（逐条确认）

### 10.1 访问与安全
1. 未输入密码前，任何 API 不返回工作区信息。  
2. 密码错误达到阈值触发锁定。  
3. 会话超时后必须重新输入密码。  

### 10.2 文件与编辑
4. 可在目录树中新建/重命名/删除文件和文件夹。  
5. 文本编辑后保存，Win10 本机立即可见。  
6. 全局搜索可在中型仓库内返回结果。  

### 10.3 Git
7. 可查看工作区改动文件列表。  
8. 可查看行级 diff。  
9. 可执行 hunk 级暂存/撤销。  

### 10.4 终端
10. 可新建多个终端标签。  
11. 断网后重连可继续看到之前输出。  
12. 后台长任务不断开（至少 2 小时）。  

### 10.5 AI
13. 可在 Codex 与 Claude Code 间切换。  
14. AI 改动必须先显示 patch 预览。  
15. AI 命令执行遵循确认策略并可追溯。  

### 10.6 跨端连续性
16. 手机和电脑可恢复同一会话上下文。  
17. 光标位置、打开标签、终端状态可恢复。  
18. 回到 Win10 本机后可无缝继续开发。  

### 10.7 插件能力（部分）
19. 主题切换可用且可持久化。  
20. SQLite 文件可打开并查看数据。  

---

## 11. 风险与应对（单机版）

1. **移动端输入效率低**：优先上线快捷键栏与命令模板。  
2. **Win10 终端兼容差异**：先锁定 PowerShell，后补 CMD/WSL。  
3. **AI 输出不稳定**：强制 patch 预览 + 命令确认。  
4. **Tailscale 连接波动**：实现自动重连与任务状态回放。  

---

## 12. 上线前最后确认（Go/No-Go）

1. 范围是否仍保持“单机、单密码、双模型、基础功能”。
2. 是否已通过 20 条最终验收清单。
3. 是否完成 3 个关键场景演练（手机救火/电脑接力/后台长任务）。
4. 是否确认 Win10 本机可见所有历史状态与结果。

> 若以上 4 项全部通过，即可进入正式使用。
